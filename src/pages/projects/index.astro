---
import Layout from '../../layouts/Layout.astro';
import { fmtKSTDate } from '../../lib/date';
import { getProjects } from '../../lib/content';

const allProjects = await getProjects();

// ✅ projectStatus 기준으로 1회 순회 분류 (O(n))
type PStatus = 'featured' | 'completed' | 'in-progress' | 'archived';
const buckets: Record<PStatus, typeof allProjects> = {
  'featured': [],
  'completed': [],
  'in-progress': [],
  'archived': [],
};

for (const p of allProjects) {
  // projectStatus가 없으면 in-progress로 취급(스키마 default와 동일)
  const s = (p.data.projectStatus ?? 'in-progress') as PStatus;
  (buckets[s] ?? buckets['in-progress']).push(p);
}

const categories = [
  "Signals & Systems",
  "Electronic Circuits",
  "Circuits Lab",
  "EM / RF",
  "Semiconductor Devices",
];

// ✅ section 정의는 bucket 참조만 (반복 최소)
const statusConfig = [
  { key: "featured" as const, label: "★ Featured",  color: "text-cyan-400",   border: "border-cyan-800" },
  { key: "completed" as const, label: "● Completed", color: "text-green-400",  border: "border-green-800" },
  { key: "in-progress" as const, label: "◐ In Progress", color: "text-yellow-400", border: "border-yellow-800" },
  { key: "archived" as const, label: "○ Archived",  color: "text-neutral-500", border: "border-neutral-700" },
];
---

<Layout title="Projects | SATL Lab">
  <main class="mx-auto max-w-4xl px-4 py-12">
    <h1 class="text-3xl font-bold">Projects</h1>
    <p class="mt-2 text-neutral-400">완성된 프로젝트를 상태/카테고리별로 정리합니다.</p>

    <div class="mt-6 flex flex-wrap gap-2">
      {categories.map((cat) => (
        <span class="rounded-full border border-neutral-700 bg-neutral-900 px-3 py-1 text-xs text-neutral-300 font-mono">{cat}</span>
      ))}
    </div>

    <!-- Status Legend -->
    <div class="mt-6 flex flex-wrap gap-4 text-xs font-mono">
      <span class="text-cyan-400">★ Featured</span>
      <span class="text-green-400">● Completed</span>
      <span class="text-yellow-400">◐ In Progress</span>
      <span class="text-neutral-500">○ Archived</span>
    </div>

    {allProjects.length === 0 ? (
      <div class="mt-10 rounded border border-neutral-800 bg-neutral-900 p-8 text-center text-neutral-500 font-mono text-sm">
        // no projects yet
      </div>
    ) : (
      <div class="mt-8 space-y-12">
        {statusConfig.map((section) => {
          const items = buckets[section.key];
          return (
            items.length > 0 && (
              <div>
                <h2 class={`text-lg font-semibold font-mono ${section.color}`}>{section.label}</h2>
                <div class="mt-4 space-y-4">
                  {items.map((post) => (
                    <a
                      href={`/projects/${post.id}`}
                      class={`group relative block overflow-hidden rounded border ${section.border} bg-neutral-900 px-5 py-4 no-underline transition hover:border-neutral-500`}
                    >
                      <div
                        class="pointer-events-none absolute inset-0 opacity-0 transition group-hover:opacity-[0.04]"
                        style="background-image: linear-gradient(rgba(255,255,255,0.5) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.5) 1px, transparent 1px); background-size: 16px 16px;"
                      />
                      <div class="relative flex items-center gap-3">
                        <span class="rounded-full border border-neutral-600 px-2 py-0.5 text-xs text-neutral-400 font-mono">
                          {post.data.category}
                        </span>

                        {/* ✅ 진행 상태 표시: projectStatus */}
                        <span class={`text-xs font-mono ${section.color}`}>
                          {post.data.projectStatus ?? "in-progress"}
                        </span>
                      </div>

                      <h3 class="relative mt-2 text-lg font-semibold text-white">{post.data.title}</h3>

                      {/* ✅ 날짜: publishedAt(정규화) */}
                      <p class="relative mt-1 text-sm text-neutral-500 font-mono">
                        {fmtKSTDate(post.data.publishedAt)}
                      </p>

                      {(post.data.summary ?? post.data.description) && (
                        <p class="relative mt-2 text-sm text-neutral-400">
                          {post.data.summary ?? post.data.description}
                        </p>
                      )}
                    </a>
                  ))}
                </div>
              </div>
            )
          );
        })}
      </div>
    )}
  </main>
</Layout>